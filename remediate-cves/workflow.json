{
  "_formatVersion": "1.0.0",
  "workflow": {
    "name": "Remediate CVEs",
    "description": "Automatically suggest and create fixes for security issues pulled directly from your backlog. Overcut assesses risk in context and triggers implementation to resolve vulnerabilities efficiently.",
    "instructions": [
      {
        "description": "Overcut will automatically analyze CVEs when you label an issue with `security-vulnerability` or `cve`",
        "action": "create_issue"
      }
    ],
    "definition": {
      "flow": [
        {
          "to": "identify-repos",
          "from": "",
          "condition": null
        },
        {
          "to": "clone-repo",
          "from": "identify-repos",
          "condition": null
        },
        {
          "to": "analyze-cve-and-plan",
          "from": "clone-repo",
          "condition": null
        },
        {
          "to": "post-remediation-plan",
          "from": "analyze-cve-and-plan",
          "condition": null
        }
      ],
      "name": "Remediate CVEs",
      "steps": [
        {
          "id": "identify-repos",
          "name": "Identify Repositories",
          "action": "repo.identify",
          "params": {
            "maxResults": 3,
            "minConfidence": 0.2
          },
          "instruction": null,
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "clone-repo",
          "name": "Clone Repository",
          "action": "git.clone",
          "params": {
            "branch": "",
            "cloneOptions": {
              "depth": 1
            },
            "repoFullName": "{{outputs.identify-repos}}"
          },
          "instruction": null,
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "analyze-cve-and-plan",
          "name": "Analyze CVE and Create Plan",
          "action": "agent.session",
          "params": {
            "goal": "Analyze CVE and create remediation plan",
            "agentIds": [
              "security-engineer-agent-id",
              "senior-developer-agent-id"
            ],
            "agentEngine": "overcut",
            "exitCriteria": {
              "timeLimit": {
                "maxDurationMinutes": 30
              },
              "userSignals": {
                "explicit": ["/done", "thanks"]
              }
            },
            "listenToComments": false,
            "keepSessionOpenForComments": false
          },
          "instruction": "You are the **Coordinator Agent** responsible for analyzing CVE security vulnerabilities and creating comprehensive remediation plans.\n\nYou will delegate specific tasks to specialized sub-agents:\n\n- **Security Engineer** â†’ Parse CVE details, assess exploitability, evaluate remediation options, and provide security guidance\n- **Senior Developer** â†’ Analyze dependency usage, trace vulnerable code paths, and assess implementation impact across the entire codebase\n\n---\n\n## Process\n\n### Step 1: Parse CVE Details\n\n- Delegate to the **Security Engineer**:\n  â€¢ Extract and validate CVE information from the issue:\n  - CVE ID (e.g., CVE-2024-12345)\n  - CVSS severity score and rating (Critical/High/Medium/Low)\n  - Vulnerability type (e.g., XSS, SQL Injection, RCE, DoS, Prototype Pollution)\n  - Description of the vulnerability\n  - Affected package/library and version ranges\n  - Links to official CVE databases (NVD, GitHub Advisory, etc.)\n    â€¢ If CVE information is incomplete or ambiguous:\n  - Search for official CVE details from NVD or GitHub Security Advisories\n  - Document any missing information that may be needed\n    â€¢ Return a structured summary of CVE details for use in subsequent steps\n\n### Step 2: Comprehensive Codebase Analysis and Remediation Evaluation\n\n- Delegate to **Security Engineer**:\n\n**Phase A: Dependency and Usage Analysis (Senior Developer)**\n\nPerform a complete scan of the codebase in a single pass:\n\n1. **Locate all instances of the vulnerable package**:\n\n   - Scan dependency files: package.json, requirements.txt, go.mod, Gemfile, pom.xml, Dockerfile, etc.\n   - Check lock files: package-lock.json, yarn.lock, Pipfile.lock, go.sum, etc.\n   - Identify direct vs. transitive dependencies\n   - Find all locations (important for monorepos)\n\n2. **Trace usage while scanning** (don't scan twice):\n\n   - Search for imports/requires of the vulnerable package\n   - Identify which files, modules, services, components use it\n   - Document specific vulnerable functions or APIs that are called\n   - Note execution contexts: runtime (API endpoints, background jobs), client-side (user interactions), build-time, tests\n\n3. **Analyze data flow**:\n   - Trace if user input reaches vulnerable code\n   - Identify authentication/authorization requirements\n   - Check for input validation or sanitization\n   - Document execution paths that could trigger the vulnerability\n\n**Phase B: Risk Assessment and Remediation Options (Security Engineer)**\n\nUsing the findings from Phase A, perform analysis:\n\n4. **Assess actual risk in context**:\n\n   - **Exploitability**: Is vulnerable code reachable? Can users trigger it? Any mitigations?\n     - Directly Exploitable / Potentially Exploitable / Limited Exposure / Not Exploitable\n   - **Business Impact**: Data breach / Unauthorized access / Limited impact / Theoretical\n     - Critical / High / Medium / Low\n   - **Context-aware Risk Level**: Combine CVSS with actual usage (may differ from CVSS)\n   - **Urgency**: Immediate / High / Medium / Low priority\n\n5. **Evaluate remediation options** (in parallel, not sequential):\n\n   **Option A: Direct Dependency Update**\n\n   - Latest patched version, version bump type (patch/minor/major)\n   - Breaking changes, compatibility concerns\n   - Effort: Low/Medium/High\n\n   **Option B: Alternative Package**\n\n   - Available alternatives, maturity, migration effort\n   - Effort: Medium/High\n\n   **Option C: Code Refactoring**\n\n   - Remove vulnerable functionality, custom implementation\n   - Effort: Medium/High\n\n   **Option D: Mitigations**\n\n   - WAF rules, runtime protections, feature flags (temporary)\n   - Effort: Low/Medium\n\n   **Option E: Workarounds**\n\n   - Patches, input validation (temporary only)\n   - Effort: Low/Medium\n\n   For each option: pros/cons, compatibility risks, testing needs, rollback strategy\n\n**Return comprehensive analysis with**:\n\n- All affected locations and usage patterns\n- Complete risk assessment with context\n- All remediation options with trade-off analysis\n\n### Step 3: Recommend Best Strategy\n\n- Delegate to **Security Engineer**:\n  â€¢ Based on the evaluated options, recommend the optimal remediation approach\n  â€¢ Consider factors:\n  - Speed of remediation vs. thoroughness\n  - Risk to production stability\n  - Effort required vs. security benefit\n  - Long-term maintainability\n    â€¢ Explain why the recommended approach is best\n    â€¢ Document why alternative approaches were not chosen\n    â€¢ Return:\n  - Primary recommendation with clear rationale\n  - Fallback option if primary approach encounters issues\n  - Timeline estimate (hours/days/weeks)\n\n### Step 4: Create Remediation Plan Document\n\n- Delegate to **Security Engineer**:\n  â€¢ Compile all findings into a structured remediation plan document\n  â€¢ Write the plan to `.overcut/cve/remediation-plan.md` in the workspace root (not inside the repo folder)\n  â€¢ Create the `.overcut/cve/` directory if it doesn't exist\n  â€¢ The plan must include:\n\n  **CVE Information Section**\n\n  - CVE ID and links to advisories\n  - CVSS score and severity\n  - Vulnerability type and description\n  - Affected package versions\n\n  **Impact Assessment Section**\n\n  - Dependencies found in codebase (with file paths)\n  - How vulnerable code is used (with code references)\n  - Exploitability analysis with reasoning\n  - Risk level (Critical/High/Medium/Low) with context\n  - Business impact assessment\n  - Affected services, components, or user flows\n\n  **Recommended Remediation Strategy Section**\n\n  - Proposed fix (e.g., \"Update express from 4.17.1 to 4.18.2\")\n  - Why this approach is recommended\n  - Breaking changes or compatibility concerns (if any)\n  - Expected effort and complexity\n  - Timeline estimate\n\n  **Alternative Options Section**\n\n  - List other approaches evaluated\n  - For each: brief description and reason it wasn't chosen\n\n  **Implementation Plan Section**\n\n  - Specific step-by-step instructions\n  - Files and dependencies that need changes\n  - Code changes required (if any beyond dependency update)\n  - Testing requirements:\n    â€¢ Existing tests that must pass\n    â€¢ New security tests to add\n    â€¢ Manual testing steps\n    â€¢ How to verify CVE is resolved\n  - Rollback plan if issues occur\n\n  â€¢ Use clear markdown formatting with headers, bullet points, and code blocks\n  â€¢ Be specific and actionable - avoid vague guidance\n  â€¢ Reference actual files, functions, and line numbers where relevant\n  â€¢ Write the complete plan to the file and confirm it was written successfully\n\n---\n\n## Output Requirements\n\nWhen the workflow completes, you MUST output the following information:\n\n```\nremediation_plan_file: .overcut/cve/remediation-plan.md\ncve_id: <CVE ID>\nrisk_level: <Critical|High|Medium|Low>\nrecommended_strategy: <brief one-line summary>\n```\n\nExample output:\n\n```\nremediation_plan_file: .overcut/cve/remediation-plan.md\ncve_id: CVE-2024-12345\nrisk_level: High\nrecommended_strategy: Update express from 4.17.1 to 4.18.2\n```\n\n**Important**: The remediation plan file must exist at the workspace root (`.overcut/cve/remediation-plan.md`), not inside the repository folder. The next step will read this file to post the plan to the issue.\n\n---\n\n## Guardrails\n\n- Always ground analysis in actual codebase usage - avoid generic CVE descriptions\n- Be honest about uncertainty - if exploitability is unclear, say so\n- Prioritize production stability - recommend safest approach even if slower\n- Consider transitive dependencies - trace full dependency trees\n- Check for multiple instances of vulnerable packages across monorepos\n- Check both runtime dependencies and dev/build dependencies\n- Document breaking changes explicitly - don't hide compatibility risks\n- Provide specific file paths, version numbers, and code references\n- If information is missing from the issue, search for official CVE details\n- Never recommend ignoring a CVE without clear evidence it's not exploitable\n- Include rollback plans for all recommendations\n- Ensure remediation plan is detailed enough for another engineer to implement\n- Pass complete context to sub-agents - they have no memory from previous calls\n- Consider the full stack: frontend, backend, infrastructure, build tools, CI/CD",
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "post-remediation-plan",
          "name": "Post Remediation Plan",
          "action": "agent.run",
          "params": {
            "agentId": "security-engineer-agent-id",
            "agentEngine": "overcut"
          },
          "instruction": "You are the **Agent** responsible for posting the CVE remediation plan to the issue and triggering the implementation workflow.\n\n---\n\n## Mission\n\nPost the completed remediation plan as a comment on the triggering issue and automatically trigger the \"Create PR from Design\" workflow to implement the fix.\n\n---\n\n## Prerequisites\n\nThe previous step has completed the remediation plan analysis with the following output:\n\n```\n{{outputs.analyze-cve-and-plan.message}}\n```\n\nThe remediation plan has been written to `.overcut/cve/remediation-plan.md` in the workspace root.\n\n---\n\n## Process\n\n### Step 1: Post the Remediation Plan\n\n- Read the remediation plan from `.overcut/cve/remediation-plan.md`\n- Verify the file exists and contains the complete plan\n- If the file is missing or empty, report an error and do not proceed\n- Post a comment to the triggering issue with:\n  - A short title: \"ðŸ”’ CVE Remediation Plan\"\n  - The complete content from the `.overcut/cve/remediation-plan.md` file\n\n**Comment Format:**\n\n```markdown\n## ðŸ”’ CVE Remediation Plan\n\n[ENTIRE CONTENT FROM .overcut/cve/remediation-plan.md]\n```\n\n**Important**:\n\n- Do not modify the plan content - post it exactly as written in the file\n- The plan should be properly formatted markdown from the previous step\n- This comment is for review purposes\n\n### Step 2: Trigger Implementation with Slash Command\n\n- Post a **separate comment** to the same issue with the `/pr` slash command\n- This comment should be short and simple\n\n**Comment Format:**\n\n```markdown\n/pr\n```\n\nOR\n\n```markdown\n/pr - Implement CVE remediation plan above\n```\n\n**CRITICAL**:\n\n- The `/pr` command must be at the very beginning of the comment\n- This should be a separate comment from the remediation plan\n- The `/pr` command will automatically trigger the \"Create PR from Design\" workflow\n- That workflow will read the remediation plan from the previous comment and implement the fix\n\n---\n\n## Rules\n\n- Always verify the remediation plan file exists before proceeding (`.overcut/cve/remediation-plan.md`)\n- Post two separate comments:\n  1. **First comment**: Remediation plan with title + complete file content\n  2. **Second comment**: Just the `/pr` slash command\n- Do not combine the plan and `/pr` command in a single comment\n- Do not modify or reformat the plan content - use it as-is from the file\n- The `/pr` command must be at the very beginning of the second comment\n- Verify both comments posted successfully\n- The `/pr` command will automatically trigger the \"Create PR from Design\" workflow",
          "stepMaxDurationMinutes": 30
        }
      ],
      "triggers": [
        {
          "event": "issue_labeled",
          "schedule": null,
          "settings": {
            "delaySeconds": 0
          },
          "conditions": {
            "field": null,
            "rules": [
              {
                "field": "context.trigger.label",
                "rules": null,
                "value": "security-vulnerability",
                "operator": "equals",
                "combinator": null
              },
              {
                "field": "context.trigger.label",
                "rules": null,
                "value": "cve",
                "operator": "equals",
                "combinator": null
              }
            ],
            "value": null,
            "operator": null,
            "combinator": "or"
          }
        },
        {
          "event": "manual",
          "slashCommand": {
            "command": "remediate-cve",
            "requireMention": false
          }
        }
      ],
      "version": "1.0.0",
      "priority": 5,
      "timeoutMs": 3600000
    }
  },
  "refs": {
    "agents": [
      {
        "id": "security-engineer-agent-id",
        "name": "Security Engineer"
      },
      {
        "id": "senior-developer-agent-id",
        "name": "Senior Developer"
      }
    ]
  }
}

{
  "_formatVersion": "1.0.0",
  "workflow": {
    "name": "Fix CI",
    "description": "Automatically analyzes CI failures, fixes the code, and commits the changes.",
    "instructions": [],
    "definition": {
      "flow": [
        {
          "to": "git-clone",
          "from": "",
          "condition": null
        },
        {
          "to": "analyze-ci-failure",
          "from": "git-clone",
          "condition": null
        },
        {
          "to": "fix-and-commit",
          "from": "analyze-ci-failure",
          "condition": null
        }
      ],
      "name": "Fix CI",
      "steps": [
        {
          "id": "git-clone",
          "name": "Clone Repo",
          "action": "git.clone",
          "params": {
            "branch": "{{trigger.ciWorkflow.branch}}",
            "repoFullName": "{{trigger.repository.fullName}}",
            "cloneOptions": {
              "depth": 1,
              "filter": {
                "type": "blob:none"
              },
              "singleBranch": true
            }
          },
          "instruction": null,
          "stepMaxDurationMinutes": 5
        },
        {
          "id": "analyze-ci-failure",
          "name": "Analyze CI Failure",
          "action": "agent.run",
          "params": {
            "agentId": "senior-developer-agent-id"
          },
          "instruction": "# CI Failure Analyzer\n\nYou are a CI Failure Analyst. Your job is to read CI workflow logs, identify exactly what failed and why, and produce a clear fix plan.\n\n## Context\n\nA CI workflow has failed on this branch. Details:\n- **Repository**: {{trigger.repository.fullName}}\n- **Branch**: {{trigger.ciWorkflow.branch}}\n- **Workflow**: {{trigger.ciWorkflow.workflowName}}\n- **Run ID**: {{trigger.ciWorkflow.runId}}\n- **Workflow URL**: {{trigger.ciWorkflow.workflowUrl}}\n\n## Instructions\n\n### Step 1: Get CI Run Details\n\nUse `get_ci_run_details` with the run ID above to get an overview of the failed CI run. Identify which jobs failed.\n\n### Step 2: Get Failure Logs\n\nFor each failing job, use `get_ci_job_logs` to retrieve the detailed logs. Focus on:\n- Error messages and stack traces\n- Failed test names and assertions\n- Build/compilation errors\n- Lint or formatting violations\n\nIf `get_ci_job_logs` is unavailable or returns insufficient detail, fall back to `get_ci_run_logs` for the full run logs.\n\n### Step 3: Identify Root Cause\n\nAnalyze the logs to determine:\n- What specifically failed (test name, build step, lint rule, etc.)\n- The root cause of each failure\n- Which source files are involved\n\n### Step 4: Cross-Reference with Source Code\n\nFor each identified issue, use `read_file` to examine the relevant source files. Confirm:\n- The error matches the actual code\n- Your proposed fix is correct\n- No other files need changes as a side effect\n\n### Step 5: Produce Output\n\nOutput your analysis in this exact format:\n\n```\nci_run_id: <run ID>\nworkflow_name: <workflow name>\nworkflow_url: <URL to the CI run>\n\n## Failing Jobs\n<list each failing job name>\n\n## Error Summary\n<concise summary of all errors>\n\n## Root Cause Analysis\n<for each error, explain the root cause with evidence from logs and source code>\n\n## Failed Commands\n<list each command that failed in CI, exactly as it appeared in the logs \u2014 e.g., `npm run lint`, `pytest tests/`, `cargo build`, `go vet ./...`>\n\n## Fix Plan\n1. File: <path> \u2014 <what to change and why>\n2. File: <path> \u2014 <what to change and why>\n...\n\nfiles_to_modify: <comma-separated list of file paths>\nfix_count: <number of fixes needed>\nfailed_commands: <comma-separated list of the exact CLI commands that failed \u2014 e.g., npm run lint, npm run build, npm test>\n```\n\n## Tool Constraints\n\n| Tool | Allowed | Purpose |\n|------|---------|---------|\n| `get_ci_run_details` | Yes | Get CI run overview |\n| `get_ci_run_logs` | Yes | Get full run logs |\n| `get_ci_job_logs` | Yes | Get per-job logs |\n| `list_pr_ci_runs` | Yes | List CI runs for the PR |\n| `read_file` | Yes | Read source files to verify root cause |\n| `search_code` | Yes | Find relevant code references |\n| `explore_repo` | Yes | Understand project structure |\n| `write_file` | **No** | |\n| `edit_file` | **No** | |\n| `terminal_command` | **No** | |\n\nThis step is **read-only**. Do NOT modify any files or run commands. Only analyze and plan.\n\n## Error Handling\n\n- If `get_ci_run_details` returns no data, try `list_pr_ci_runs` to find the latest failed run\n- If logs are truncated, focus on the last error messages \u2014 CI logs typically show the most relevant errors at the end\n- If you cannot determine the root cause for a failure, include it in the output with `root_cause: unclear \u2014 <what you know>` so the next step can investigate further",
          "stepMaxDurationMinutes": 15
        },
        {
          "id": "fix-and-commit",
          "name": "Fix and Commit",
          "action": "agent.run",
          "params": {
            "agentId": "senior-developer-agent-id"
          },
          "instruction": "# CI Fix Implementer\n\nYou are a CI Fix Implementer. Your job is to apply code fixes based on a CI failure analysis, commit the changes, and push to the branch.\n\n## Context\n\n- **Repository**: {{trigger.repository.fullName}}\n- **Branch**: {{trigger.ciWorkflow.branch}}\n- **CI Run URL**: {{trigger.ciWorkflow.workflowUrl}}\n\n### CI Failure Analysis\n\n{{outputs.analyze-ci-failure.message}}\n\n## Instructions\n\n### Step 1: Review the Fix Plan\n\nRead the fix plan from the analysis above. For each file listed in `files_to_modify`, use `read_file` to examine the current state of the code and confirm the planned fix is correct.\n\nIf the fix plan is unclear or incomplete for any item, use `search_code` and `read_file` to gather more context before proceeding.\n\n### Step 2: Implement Fixes\n\nFor each item in the fix plan:\n1. Use `edit_file` to make the necessary change\n2. Keep changes **minimal and focused** \u2014 fix only what the CI failure requires\n3. Do NOT refactor, improve, or clean up surrounding code\n4. Do NOT add unrelated changes, comments, or documentation\n\n**CRITICAL \u2014 Legitimate Fixes Only:**\n\nYou must apply **real fixes** that address the root cause. The following are **strictly forbidden**:\n\n- **Do NOT delete or skip failing tests** to make the suite pass\n- **Do NOT comment out erroring code** to silence failures\n- **Do NOT add `@ts-ignore`, `// eslint-disable`, `# type: ignore`, `#pragma: no cover`, `@SuppressWarnings`, or any suppression directive** to bypass checks\n- **Do NOT use `any` type casts**, unsafe coercions, or `as unknown as X` to work around type errors\n- **Do NOT replace assertions with weaker checks** (e.g., changing `toEqual` to `toBeDefined`) to make a test pass\n- **Do NOT add empty catch blocks** to swallow errors\n- **Do NOT stub or mock out the failing logic** unless the test was already a mock-based test\n\nEvery fix must correct the **actual defect** in the code \u2014 wrong logic, missing import, incorrect type, bad assertion, etc.\n\n**When a fix requires a major change:**\n\nIf the root cause cannot be fixed locally (e.g., it requires an architectural change, a new dependency, upstream API changes, or a large refactor), do NOT apply a workaround. Instead:\n1. Do NOT commit any code changes for that issue\n2. Post a PR comment explaining why the fix cannot be applied automatically:\n   - What the root cause is\n   - Why it requires a larger change\n   - A suggested approach for the developer\n3. Report that issue as unfixed in your output\n\n### Step 3: Validate Fixes Locally\n\n**Before committing, re-run the failed CI commands locally to confirm the fix actually works.** This prevents a cycle of push \u2192 fail \u2192 fix \u2192 push \u2192 fail.\n\n1. Read the `failed_commands` field from the analysis above\n2. For each failed command, use `terminal_command` to run it from the repository root\n3. If a command **passes** \u2014 move on to the next\n4. If a command **fails** \u2014 read the new error output, adjust your fix with `edit_file`, and re-run the command\n5. Repeat up to **3 attempts per command**. If it still fails after 3 attempts, stop and report `status: partial` with details on what you tried\n\n**Examples of commands to run:**\n- Lint: `npm run lint`, `eslint .`, `ruff check .`, `go vet ./...`\n- Build: `npm run build`, `cargo build`, `go build ./...`, `tsc --noEmit`\n- Test: `npm test`, `pytest`, `go test ./...`, `cargo test`\n- Format: `npm run format -- --check`, `prettier --check .`, `black --check .`\n\nIf the analysis does not include `failed_commands`, infer the appropriate validation command from the error type (e.g., test failure \u2192 run the test suite, lint error \u2192 run the linter).\n\n### Step 4: Review Changes\n\nAfter all validations pass:\n1. Review each modified file with `read_file` to confirm the changes are correct\n2. Ensure no unintended side effects were introduced\n3. If a fix looks wrong, revert it with `edit_file` and try a different approach\n\n### Step 5: Commit and Push\n\nUse `terminal_command` to run git commands:\n1. `git add <file1> <file2> ...` \u2014 stage only the files you modified (do NOT use `git add .`)\n2. `git commit -m \"fix(ci): <concise description>\"` \u2014 use conventional commit format\n3. `git push` \u2014 push to the current branch\n\n**Commit message guidelines:**\n- Prefix with `fix(ci):`\n- Be specific: `fix(ci): correct import path for utils module` not `fix(ci): fix CI`\n- If multiple unrelated fixes, summarize: `fix(ci): resolve missing import and update test assertion`\n\n### Step 6: Post PR Comment\n\nPost a comment on the PR summarizing what was fixed. Use `add_pull_request_review_thread` to add a general comment with this format:\n\n```\n## CI Fix Applied\n\n**Failed CI Run**: {{trigger.ciWorkflow.workflowName}} \u2014 {{trigger.ciWorkflow.workflowUrl}}\n\n### Changes Made\n- <describe each fix applied>\n\n### Files Modified\n- <list each file path>\n```\n\n## Output\n\n```\nstatus: <fixed|partial|failed>\nfixes_applied: <number of fixes successfully applied>\nfiles_modified: <comma-separated list of modified file paths>\nvalidation_passed: <yes|no|partial \u2014 did the local validation commands pass?>\ncommit_sha: <the new commit SHA from git log, or \"none\" if not committed>\n```\n\n- `fixed` \u2014 All fixes applied AND all validation commands pass locally\n- `partial` \u2014 Some fixes applied but validation still fails, or some fixes could not be applied (explain details)\n- `failed` \u2014 Unable to apply any fixes or all validations fail after retries (explain why)\n\n## Tool Constraints\n\n| Tool | Allowed | Purpose |\n|------|---------|---------|\n| `read_file` | Yes | Read source files |\n| `edit_file` | Yes | Apply code fixes |\n| `write_file` | Yes | Create new files if needed |\n| `search_code` | Yes | Find code references |\n| `terminal_command` | Yes | Validation commands (lint, build, test, format) and git commands (add, commit, push) |\n| `update_pull_request` | Yes | Post PR comment |\n| `add_pull_request_review_thread` | Yes | Post review comment |\n| `delete_file` | **No** | |\n| `create_pull_request` | **No** | |\n| `merge_pull_request` | **No** | |\n\n## Error Handling\n\n- If a file from the fix plan does not exist, skip it and note in the output\n- If `edit_file` fails, try reading the file again and adjusting the edit \u2014 the file content may have changed\n- If a validation command fails after 3 retry attempts, do NOT commit or push \u2014 report `status: partial` with the failing command output\n- If `git push` fails due to conflicts, report `status: failed` with details \u2014 do NOT force-push or rebase\n- If you cannot fix an issue, still attempt the remaining fixes, validate what you can, and report `status: partial`",
          "stepMaxDurationMinutes": 30
        }
      ],
      "triggers": [
        {
          "event": "ci_workflow_failed",
          "conditions": {
            "combinator": "and",
            "rules": [
              {
                "field": "context.ciWorkflow.isPullRequest",
                "operator": "equals",
                "value": "true"
              }
            ]
          }
        },
        {
          "event": "manual",
          "slashCommand": {
            "command": "fix-ci",
            "requireMention": false
          }
        }
      ],
      "version": "1.0.0",
      "priority": 3,
      "timeoutMs": 3600000
    }
  },
  "refs": {
    "agents": [
      {
        "id": "senior-developer-agent-id",
        "name": "Senior Developer",
        "type": "SeniorDeveloper"
      }
    ]
  }
}

{
  "_formatVersion": "1.0.0",
  "workflow": {
    "name": "Create PR from Design",
    "description": "Accelerate your SDLC with a repeatable, spec-driven process that turns approved designs into code. Overcut automatically generates Pull Requests from design specs, helping you clear backlog tickets efficiently while ensuring strict adherence to approved requirements.",
    "definition": {
      "flow": [
        {
          "to": "identify-repos",
          "from": "",
          "condition": null
        },
        {
          "to": "clone-repo",
          "from": "identify-repos",
          "condition": null
        },
        {
          "to": "prep-context",
          "from": "clone-repo",
          "condition": null
        },
        {
          "to": "planning",
          "from": "prep-context",
          "condition": null
        },
        {
          "to": "setup-pr",
          "from": "planning",
          "condition": null
        },
        {
          "to": "implement-changes",
          "from": "setup-pr",
          "condition": null
        },
        {
          "to": "validate-implementation",
          "from": "implement-changes",
          "condition": null
        },
        {
          "to": "finalize-pr",
          "from": "validate-implementation",
          "condition": null
        }
      ],
      "name": "Create PR from Design",
      "steps": [
        {
          "id": "clone-repo",
          "name": "Clone Repository",
          "action": "git.clone",
          "params": {
            "branch": "",
            "cloneOptions": {
              "depth": 1
            },
            "repoFullName": "{{outputs.identify-repos}}"
          },
          "instruction": null,
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "identify-repos",
          "name": "Identify Repositories",
          "action": "repo.identify",
          "params": {
            "maxResults": 3,
            "minConfidence": 0.2
          },
          "instruction": null,
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "prep-context",
          "name": "Prepare Context",
          "action": "agent.run",
          "params": {
            "agentId": "cme8k3nx300011f331m3bobl4"
          },
          "instruction": "You are the Agent responsible for preparing the execution context before planning begins.\n\n## Mission\n\nAnalyze the triggering issue to understand its dependencies and scope within a larger initiative. Determine the correct base branch for implementation \u2014 either the default branch or a dependency's PR branch \u2014 and establish clear scope boundaries for the planning step.\n\n## Overall Process\n\n1. Read the triggering issue carefully, including title, body, and all comments using `read_ticket`.\n\n2. **Identify Dependencies and Related Work:**\n   - Check for references to a parent epic, related issues, or labels indicating this ticket is part of a larger initiative broken into smaller tickets.\n   - Look for explicit dependency markers: \"depends on\", \"blocked by\", \"after #X\", \"requires #X\", links to parent epics, or sequential numbering that implies ordering.\n   - If related tickets exist, read them to understand the broader initiative.\n\n3. **For each dependency ticket found:**\n   - Check if it has an associated open or merged pull request.\n   - Determine the dependency's status: open (no PR), in-progress (open PR), or completed (merged PR).\n\n4. **Resolve base branch based on dependency status:**\n\n   ### No Dependencies Found\n\n   - Stay on the current branch (the default/cloned branch).\n   - Proceed to output.\n\n   ### Dependency Exists \u2014 PR Available\n\n   - If the dependency has an **open PR**: fetch and checkout the PR's head branch so planning and implementation build on the latest dependency code.\n   - If the dependency has a **merged PR**: stay on the default branch (the code is already merged).\n   - If multiple dependencies exist, use the most recent/relevant open PR branch.\n   - Run `git pull` to ensure the branch is up to date.\n\n   ### Dependency Exists \u2014 Not Ready\n\n   - If a dependency ticket is still open with **no associated PR**, the required code is not available yet.\n   - **Stop the workflow** and report the blocker clearly.\n   - Use the `update_status` tool with a failure status.\n   - Output with status: blocked and the blocker reason following the template below.\n\n5. **Establish Scope Boundaries:**\n   - From the related tickets analysis, identify exactly which portion of work belongs to **this** ticket.\n   - List sibling tickets and their scope to clarify what is out-of-scope.\n   - Other tickets from the same initiative may be worked on concurrently by other agents \u2014 any extension beyond scope risks merge conflicts.\n\n6. Output all findings for the next step.\n\n---\n\n## Output Requirements\n\nWhen the step completes successfully, you MUST output:\n\n### If Ready to Proceed\n\n```\nstatus: ready\nbase_branch: <branch_name>\n\n## Scope\n\n### This Ticket\n- <ticket_url>: <brief description of what this ticket covers>\n\n### Related Tickets (Out of Scope)\n- <ticket_url>: <brief description> \u2014 Status: <open/in-progress/completed>\n- <ticket_url>: <brief description> \u2014 Status: <open/in-progress/completed>\n\n### Dependency Resolution\n- <\"No dependencies \u2014 using default branch\" or \"Checked out PR branch <branch_name> from <pr_url>\">\n```\n\n### If Blocked\n\n```\nstatus: blocked\nblocker: <ticket_url> \u2014 <reason, e.g., \"dependency ticket has no PR yet, code not available\">\n\n## Context\n- This ticket depends on <ticket_url> which is still open without a pull request.\n- Implementation cannot proceed until the dependency is resolved.\n```\n\n---\n\n## Behavior Rules\n\n\u2022 Read the triggering issue thoroughly before checking dependencies.\n\u2022 Check ALL referenced tickets, not just the first one found.\n\u2022 When checking for PRs, search by issue reference and by branch naming patterns.\n\u2022 If switching branches, verify the checkout succeeded and the branch is up to date.\n\u2022 Scope boundaries must be specific \u2014 list each related ticket with its responsibility.\n\u2022 Do NOT start planning or write any code \u2014 that's the next step's responsibility.\n\u2022 Do NOT create branches or PRs \u2014 that's a later step's responsibility.\n\u2022 If blocked, output the blocker clearly and stop. Do not attempt workarounds.",
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "planning",
          "name": "Planning",
          "action": "agent.session",
          "params": {
            "goal": "Create a plan for a new PR",
            "agentIds": [
              "cme8k3nx300011f331m3bobl4",
              "cme8kpihf0003t3uzn7ecwiin"
            ],
            "agentEngine": "overcut",
            "exitCriteria": {
              "timeLimit": {
                "maxDurationMinutes": 120
              },
              "userSignals": {
                "explicit": [
                  "/done",
                  "thanks"
                ]
              }
            },
            "listenToComments": false,
            "keepSessionOpenForComments": false
          },
          "instruction": "You are an expert software engineer. You are given a task to create a plan for a new PR.\n\n## Step 0 - Check for Blocker\n\nBefore doing anything, check if the prep-context output below contains `status: blocked`. If it does, **immediately** output the same blocker message verbatim and stop. Do not proceed with any other steps.\n\n## Step 1 - Detect Existing Design\n\n1. Read the triggering issue carefully, including its title, body, and all comments using `read_ticket`.\n2. Scan the issue comments for a detailed design (look for the marker `### Proposed Design` or any design-like content such as architecture decisions, implementation approaches, system impact analysis, or technical specifications).\n3. If a design is found, follow **Path A**. Otherwise, follow **Path B**.\n\n### Path A \u2014 Existing Design Found\n\n1. Use the most recent approved design as the primary reference for the implementation plan.\n2. Cross-reference the design with the current codebase to verify file paths and interfaces are still accurate.\n3. Review any comments posted **after** the design comment for feedback, amendments, or approvals \u2014 incorporate those into the plan.\n4. Proceed to **Prepare Implementation Plan** below, using the design document as the foundation.\n\n### Path B \u2014 No Existing Design\n\n1. Read requirements directly from the issue title, body, and comment thread.\n2. Follow the conversation on the issue and comments and make sure to use the latest approved requirements as reference.\n3. Review the codebase for architecture context, similar implementations, and existing patterns.\n4. Proceed to **Prepare Implementation Plan** below, using the gathered requirements as the foundation.\n\n## Prepare Implementation Plan\n\n**Important**: The scope boundaries for this ticket have already been established in the previous step. Use the context below to understand what is in-scope and out-of-scope. Do NOT extend the plan beyond this ticket's scope \u2014 sibling tickets may be worked on concurrently by other agents.\n\n1. Your plan should focus on the functional changes only. Do not include any changes to tests, documentation, or other non-functional changes.\n2. Follow the project's architecture and coding standards strictly. Review similar implementations in the repo before planning. Look for common patterns, directory structure, service boundaries, and existing extension points.\n3. Do not introduce new packages, libraries, or external dependencies unless explicitly requested.\n4. If you believe such an addition is required, mark it as \"new dependency\" in your plan.\n5. Do not include in your plan any changes to non-functional files like tests, documentation, or other non-functional changes.\n6. Do not write code. Your task is to create a plan for the next agent to implement.\n7. The implementation plan must be broken into sequential phases.\n   - Each phase should contain small tasks that can be executed independently.\n   - The plan should be easy to track across phases.\n8. Return the final plan so the next agent can implement it.\n\n---\n\n### Example Implementation Plan\n\n\\`\\`\\`markdown\n\n# Implementation Plan\n\n## Goal\n\nThe goal of this implementation plan is to introduce a new user preferences update endpoint that integrates cleanly with existing controllers, services, and repository layers while preserving the project architecture and ensuring only functional changes are applied.\n\n## Phase 1 - Add API Endpoint\n\n1. Create a new controller method under `src/controllers/userPreferences.controller.ts` to handle updating user preferences.\n2. Add a new route entry in `src/routes/userPreferences.routes.ts` pointing to the new controller method.\n3. Reuse the existing validation pattern seen in `src/controllers/profile.controller.ts` to validate the incoming payload.\n4. Ensure the controller method delegates logic to the service layer without adding business logic inside the controller.\n\n## Phase 2 - Implement Service Logic\n\n1. Add a new method `updateUserPreferences` in `src/services/userPreferences.service.ts`.\n2. Follow the pattern used in the `profile.service.ts` update method for data fetching and persistence.\n3. Ensure the service loads the current user record and applies only the fields defined in the requirements.\n4. Return a normalized DTO object consistent with existing service returns.\n\n## Phase 3 - Repository and Data Layer Updates\n\n1. Add a new repository method in `src/repositories/user.repository.ts` for saving updated preference fields.\n2. Follow naming conventions used in `src/repositories/profile.repository.ts`.\n3. Confirm that only the required fields are persisted and no unrelated data is modified.\n\n## Phase 4 - Wire Up Dependency Configuration\n\n1. Register the new service and repository references in the project dependency container in `src/config/container.ts`.\n2. Follow the same pattern used for profile and settings components.\n   \\`\\`\\`\n\n---\nScope and Context from Previous Step:\n{{outputs.prep-context}}",
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "setup-pr",
          "name": "Setup PR",
          "action": "agent.run",
          "params": {
            "agentId": "cme8k3nx300011f331m3bobl4"
          },
          "instruction": "You are the Agent responsible for setting up the implementation environment for a new PR from an approved design document.\n\n## Mission\n\nCreate the implementation branch and draft pull request based on the implementation plan, then post a link to the issue. This provides immediate visibility and a single entry point for monitoring implementation progress.\n\n**Prerequisites**:\n\n- An approved design document exists in the issue or comments\n- Implementation plan has been created in the previous step\n- Repository has been cloned\n\n## Inputs\n\nFrom the triggering issue and previous steps:\n\n- `issue_url`: URL of the triggering issue\n- `issue_title`: Title of the issue\n- `implementation_plan`: The implementation plan from the planning step.\n- `base_branch`: The base branch determined by the prep-context step (may be the default branch or a dependency's PR branch).\n\n## Step 0 - Check for Blocker\n\nBefore doing anything, check if the prep-context output below contains `status: blocked`. If it does, **immediately** output the same blocker message verbatim and stop. Do not proceed with any other steps.\n\n## Overall Process\n\n1. Pull the latest changes from origin for the current branch.\n\n2. Create a new implementation branch:\n   - Branch name: `prbuilder/<slug>` where slug is derived from the issue title (keep it up to 50 characters for clarity)\n   - Create from the current branch (already set to the correct base by the prep-context step)\n   - Verify branch creation succeeded\n\n3. Parse the implementation plan to extract:\n   - Overall goal\n   - All phases and their tasks\n   - Expected changes and scope\n\n4. Create a **draft pull request**:\n   - Check if a PR already exists for this branch, if it does, update it\n   - Title: `[DRAFT] <issue_title>`\n   - Body: Initial description (use template below)\n   - Mark as **draft**\n   - Base branch: The current branch (set by prep-context \u2014 may be the default branch or a dependency's PR branch)\n   - This PR will be updated with progress in the next steps\n\n5. Post a comment on the triggering issue:\n   - Include link to the draft PR\n   - Note that implementation is starting\n   - Mention that progress can be monitored in the PR\n\n6. Output the branch name and draft PR URL for the next step.\n\n---\n\n## Initial Draft PR Description Template\n\n```markdown\n# \ud83d\udea7 <issue_title>\n\n**Status**: Work in Progress (Draft)\n**Issue**: <issue_url>\n\n## Implementation Plan\n\nThis PR implements the following plan:\n\n<Include high-level summary of phases from the implementation plan>\n\n## Implementation Progress\n\nImplementation is in progress. This PR will be updated with:\n\n- Progress tracking with checkboxes for each phase\n- Commits for each completed phase\n- Test results and validation\n- Final review-ready status\n\n## Branch Information\n\n- **Implementation Branch**: `prbuilder/<slug>`\n- **Base Branch**: <base_branch_name>\n- **Merge Target**: Base branch (set by prep-context)\n\nThis description will be updated with full details once implementation begins.\n\n---\n\n_This is a draft PR. Progress can be monitored in real-time._\n```\n\n---\n\n## Issue Comment Template\n\nPost this comment on the triggering issue:\n\n```markdown\n## \ud83d\ude80 Implementation Started\n\n**Branch**: `prbuilder/<slug>`\n**Draft PR**: <draft_pr_url>\n\nImplementation is now in progress. You can monitor real-time progress in the draft PR above.\n\nThe implementation will follow the plan created in the previous step and will be committed in phases.\n```\n\n---\n\n## Output Requirements\n\nWhen the workflow completes successfully, you MUST output the following information:\n\n```\nbranch_name: prbuilder/<slug>\ndraft_pr_url: <URL to the draft PR>\nbase_branch: <base_branch_name>\n```\n\nExample output:\n\n```\nbranch_name: prbuilder/add-user-preferences-endpoint\ndraft_pr_url: https://github.com/org/repo/pull/456\nbase_branch: main\n```\n\n---\n\n## Coordinator Behavior Rules\n\n\u2022 Pull latest changes before creating branch.\n\u2022 Create implementation branch with clear naming: `prbuilder/<slug>`.\n\u2022 Branch from the current branch (already set by prep-context).\n\u2022 Create draft PR with the current branch as base.\n\u2022 Use the Initial Draft PR Description template - keep it simple and plan-focused.\n\u2022 Post comment on triggering issue with link to draft PR.\n\u2022 Output all required information for the next step.\n\u2022 Do NOT implement any code - that's the next step's responsibility.\n\u2022 Verify branch and PR creation succeeded before completing.\n\n---\nImplementation Plan: \n{{outputs.planning}}",
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "implement-changes",
          "name": "Implement Changes",
          "action": "agent.session",
          "params": {
            "goal": "Implement code changes based on the plan",
            "agentIds": [
              "cme8k3nx300011f331m3bobl4",
              "cme8kpihf0003t3uzn7ecwiin"
            ],
            "agentEngine": "overcut",
            "exitCriteria": {
              "timeLimit": {
                "maxDurationMinutes": 180
              },
              "userSignals": {
                "explicit": [
                  "/done",
                  "thanks"
                ]
              }
            },
            "listenToComments": false,
            "keepSessionOpenForComments": false
          },
          "instruction": "You are the Coordinator Agent responsible for implementing code changes based on a predefined implementation plan.\n\n## Mission\n\nCoordinate Developer agents to implement all phases from the implementation plan, tracking progress with a PR comment, committing after each phase, and collecting implementation summaries.\n\n**Prerequisites**:\n\n- Setup step must be complete with implementation branch and draft PR created\n- Implementation plan is available from the planning step\n\n## Previous Step Output\n\n```\n{{outputs.setup-pr.message}}\n```\n\n### Implementation Plan\n\n```\n{{outputs.planning}}\n```\n\n## Step 0 - Check for Blocker\n\nBefore doing anything, check if any previous step output contains `status: blocked`. If it does, **immediately** output the same blocker message verbatim and stop. Do not proceed with any other steps.\n\n## Overall Process\n\n1. Receive the implementation plan from the previous step.\n\n2. Parse the implementation plan to extract all phases and their tasks.\n\n3. Post the implementation plan as a PR comment with checkboxes for progress tracking.\n\n4. For each phase in the plan:\n\n   - Group related tasks from the phase (2-4 tasks per iteration)\n   - Delegate to the appropriate Developer agent\n   - Developer makes changes and stages them with `git add`\n   - Commit staged changes with message: `Implement Phase <N>: <phase_title>`\n   - Push commit to remote branch immediately\n   - Update the checkbox comment to mark phase as complete\n   - Collect summary of changes\n\n5. After all phases are implemented, compile final output with all summaries.\n\n---\n\n## Step 0 - Acknowledge\n\nUse the `update_status` tool with a message that you are starting the implementation workflow.\n\n---\n\n## Step 1 - Receive and Parse Implementation Plan\n\n**Prerequisites**: The Implementation Plan has already been created in the planning step.\n\n**Your job**:\n\n- Parse the plan to extract all phases and their tasks\n- Create a simplified tracking list with phase titles\n- Keep the full plan accessible for task details\n\n---\n\n## Step 2 - Post Implementation Plan as PR Comment\n\nCreate a new PR comment with the implementation plan phases as checkboxes.\n\n**Comment Format**:\n\n```markdown\n## \ud83d\udd27 Implementation Progress\n\nImplementing the following phases:\n\n- [ ] [PHASE-1] <Phase 1 Title>\n- [ ] [PHASE-2] <Phase 2 Title>\n- [ ] [PHASE-3] <Phase 3 Title>\n\n---\n\n_This comment will be updated as phases are completed._\n```\n\n**Requirements**:\n\n- Use GitHub markdown checkbox format `- [ ]` for uncompleted items\n- Use GitHub markdown checkbox format `- [x]` for completed items\n- Show only phase titles with [PHASE-X] identifiers\n- Store the comment ID for future updates\n\n---\n\n## Step 3 - Implement Phases (Iterative)\n\nFor each phase in the implementation plan:\n\n### 3.1 - Implement the Phase\n\nCall the Developer agent and instruct:\n\n```\nYou are acting as a Developer.\n\nImplement the following tasks from Phase <N>: <phase_title>\n\nTasks:\n<List all tasks from this phase>\n\nImplementation Instructions:\n- Read the task descriptions carefully\n- Follow the project's architecture and coding standards\n- Review similar implementations in the repo for patterns\n- Make the necessary code changes only\n- Do NOT run tests, lint, coverage, typechecking, or any validation\n- Stage all changes using `git add <files>`\n- Keep changes strictly limited to the specified tasks\n- Return a short summary of the changes made\n\nCritical Constraints:\n- Do not introduce new packages or dependencies unless specified in the plan\n- Use existing infrastructure and patterns from the repository\n- Focus on functional changes only\n- No tests, documentation, or other non-functional changes yet\n```\n\n### 3.2 - Commit and Push\n\nAfter the Developer completes the phase, call the Developer agent again and instruct:\n\n```\nYou are acting as a Developer.\n\nCommit and push the staged changes:\n\n- Verify changes are staged with `git status`\n- Commit staged changes with message: `Implement Phase <N>: <phase_title>`\n- Push the commit to remote branch immediately with `git push`\n- Return the commit short SHA (first 7 characters)\n\nThis ensures changes are visible on the PR in real-time.\n```\n\n### 3.3 - Update Checkbox Comment\n\nAfter committing and pushing:\n\n- Use the `update_pull_request_comment` tool to update the tracking comment\n- Change the completed phase's checkbox from `- [ ]` to `- [x]`\n- Add the commit short SHA in parentheses next to the completed phase (use plain text, no quotes or backticks)\n- Keep all other phases unchanged\n\n**Example Update** (after completing Phase 1):\n\n```markdown\n## \ud83d\udd27 Implementation Progress\n\nImplementing the following phases:\n\n- [x] [PHASE-1] Add API Endpoint (a1b2c3d)\n- [ ] [PHASE-2] Implement Service Logic\n- [ ] [PHASE-3] Repository and Data Layer Updates\n\n---\n\n_This comment will be updated as phases are completed._\n```\n\n### 3.4 - Collect Summary\n\nStore the implementation summary from the Developer for the final output.\n\n### 3.5 - Continue to Next Phase\n\nRepeat steps 3.1-3.4 for each remaining phase in the implementation plan.\n\n---\n\n## Step 4 - Final Summary\n\nAfter all phases are completed:\n\nUse the `update_status` tool to report completion:\n\n```\nAll implementation phases completed. <N> phases implemented and committed.\n```\n\n---\n\n## Task Grouping Strategy\n\nWhen delegating tasks to the Developer:\n\n- Combine related tasks from the same phase when possible\n- Group tasks that work on the same file, module, or closely related functionality\n- Keep each iteration manageable - avoid too many tasks in a single delegation\n- Aim for 2-4 related tasks per iteration as a guideline\n- Clearly specify the exact scope for the current iteration\n- The Developer must not run tests, coverage, lint, or any validation tools. These are explicitly prohibited during task execution.\n\n---\n\n## Output Requirements\n\nWhen the workflow completes, you MUST output:\n\n```markdown\n# Implementation Summary\n\n## Phases Completed\n\n### Phase 1: <phase_title>\n\n- Commit SHA: <commit_sha>\n- Changes: <summary>\n\n### Phase 2: <phase_title>\n\n- Commit SHA: <commit_sha>\n- Changes: <summary>\n\n## Statistics\n\n- Total Phases: <N>\n- Total Commits: <N>\n- Branch: <branch_name>\n- Draft PR: <draft_pr_url>\n```\n\n---\n\n## Critical Requirements\n\n\u2705 **MUST DO**:\n\n- Post the implementation progress comment BEFORE starting any implementation\n- Commit each phase with a descriptive commit message\n- Push each commit to remote branch immediately after committing\n- Update the checkbox comment after EACH completed phase (not just at the end)\n- Add the commit short SHA in parentheses next to each completed phase (plain text)\n- Use proper GitHub markdown checkbox syntax with [PHASE-X] identifiers\n- Collect summaries from each phase for final output\n\n\u274c **MUST NOT**:\n\n- Skip creating the initial progress tracking comment\n- Wait until all phases are done before updating checkboxes\n- Create multiple tracking comments (use ONE comment and update it)\n- Leave phases unchecked if they are completed\n- Run tests, lint, or validation during implementation (that's next step)\n- Commit all changes at once (commit per phase)\n\n---\n\n## Coordinator Behavior Rules\n\n\u2022 Parse the implementation plan to extract phases and tasks.\n\u2022 Post progress tracking comment before starting implementation.\n\u2022 For each phase:\n\n- Delegate to Developer with clear task list and constraints\n- Developer stages changes with `git add`\n- Commit with message: `Implement Phase <N>: <phase_title>`\n- Push to remote immediately\n- Update checkbox comment with commit SHA\n- Collect implementation summary\n  \u2022 Always pass complete context to Developer agents (they have zero memory).\n  \u2022 Never write code yourself - only the Developer may write code.\n  \u2022 Track progress meticulously with checkbox updates after each phase.\n  \u2022 Provide detailed final summary with all commits and changes.\n  \u2022 Do NOT run tests or validation - that's the next step's responsibility.\n  \u2022 Do NOT update the draft PR description - that's the finalization step's responsibility.",
          "stepMaxDurationMinutes": 180
        },
        {
          "id": "validate-implementation",
          "name": "Validate Implementation",
          "action": "agent.session",
          "params": {
            "goal": "Write tests and validate implementation",
            "agentIds": [
              "cme8k3nx300011f331m3bobl4",
              "cme8kpihf0003t3uzn7ecwiin"
            ],
            "agentEngine": "overcut",
            "exitCriteria": {
              "timeLimit": {
                "maxDurationMinutes": 60
              },
              "userSignals": {
                "explicit": [
                  "/done",
                  "thanks"
                ]
              }
            },
            "listenToComments": false,
            "keepSessionOpenForComments": false
          },
          "instruction": "You are the Agent responsible for validating the implementation: writing comprehensive tests, running lint and format checks, and ensuring the feature is ready for review.\n\n## Mission\n\nWrite comprehensive tests for all implemented functionality, run lint and format validation, fix any issues, and ensure the implementation is complete and ready for final PR preparation.\n\n**Prerequisites**:\n\n- Implementation step must be complete with all phases committed and pushed\n- Draft PR exists from setup step\n\n## Previous Step Output with Implementation Summary\n\n```\n{{outputs.implement-changes.message}}\n```\n\n## Step 0 - Check for Blocker\n\nBefore doing anything, check if the prep-context output below contains `status: blocked`. If it does, **immediately** output the same blocker message verbatim and stop. Do not proceed with any other steps.\n\n\n## Overall Process\n\n1. Verify all commits are pushed to remote:\n\n   - Check git status for any unpushed commits\n   - If unpushed commits exist, push them immediately\n\n2. Write comprehensive tests:\n\n   - Call Developer agent to write tests for all new functionality\n   - Run tests to ensure they pass\n   - Stage test files\n   - Commit tests with message: `Add tests for implementation`\n   - Push commit to remote immediately\n\n3. Run final validation:\n\n   - Call Developer agent to run lint and format\n   - Fix any detected issues\n   - Stage fixes\n   - Commit fixes with message: `Fix lint and format issues`\n   - Push commit to remote immediately\n\n4. Compile validation summary for the next step.\n\n---\n\n## Step 1 - Verify Unpushed Commits\n\nCall the Developer agent and instruct:\n\n```\nYou are acting as a Developer.\n\nCheck for any unpushed commits:\n\n- Run `git status` to check for unpushed commits\n- If there are unpushed commits, push them to remote with `git push`\n- Return status: \"All commits pushed\" or \"Pushed N unpushed commits\"\n```\n\n---\n\n## Step 2 - Write Tests\n\nCall the Developer agent and instruct:\n\n```\nYou are acting as an expert test engineer, writing comprehensive tests for the new logic.\n\nWrite tests for all new functionality implemented in this PR.\n\nStrictly follow any specific rules, standards, or guidelines from your role context or repository documentation regarding:\n\u2022 Which testing frameworks to use\n\u2022 What testing standards and patterns to follow\n\u2022 Which areas should have tests and which should be skipped\n\u2022 Code coverage expectations\n\u2022 Test file organization and naming conventions\n\nImplementation Summary (for context):\n<Implementation summary from previous step>\n\nInstructions:\n- Read the implementation code to understand what was built\n- Write comprehensive tests covering all new functionality\n- Include unit tests, integration tests as appropriate\n- Test edge cases and error handling\n- Run the tests to ensure they pass\n- Stage all test files using `git add`\n- Return a short summary of the tests written\n\nDo NOT commit or push yet.\n```\n\nAfter Developer completes, call the Developer agent again and instruct:\n\n```\nYou are acting as a Developer.\n\nCommit and push the test files:\n\n- Verify test files are staged with `git status`\n- Commit staged changes with message: `Add tests for implementation`\n- Push the commit to remote branch immediately with `git push`\n- Return the commit short SHA (first 7 characters)\n```\n\n---\n\n## Step 3 - Run Lint and Format Validation\n\nCall the Developer agent and instruct:\n\n```\nYou are acting as an expert developer, performing final validation on the implementation.\n\nPerform a final validation sweep:\n\n1. Run lint to check for code quality issues\n2. Run formatter to ensure consistent code style\n3. Fix any detected issues\n4. Stage all fixes using `git add`\n5. Return a short summary of validation results and any fixes made\n\nInstructions:\n- Run the project's linter based on the project's configuration\n- Run the project's formatter based on the project's configuration\n- Fix all detected issues\n- Stage all changes\n- Report validation results (pass/fail, issues found, issues fixed)\n\nDo NOT commit or push yet.\n```\n\nAfter Developer completes, call the Developer agent again and instruct:\n\n```\nYou are acting as a Developer.\n\nCommit and push the validation fixes:\n\n- Verify fixes are staged with `git status` (if any)\n- If there are staged changes:\n  - Commit staged changes with message: `Fix lint and format issues`\n  - Push the commit to remote branch immediately with `git push`\n  - Return the commit short SHA (first 7 characters)\n- If there are no staged changes:\n  - Return \"No validation fixes needed\"\n```\n\n---\n\n## Step 4 - Final Summary\n\nAfter all validation steps are completed:\n\nUse the `update_status` tool to report completion:\n\n```\nValidation complete. Tests added and passing. Lint and format checks passed.\n```\n\n---\n\n## Output Requirements\n\nWhen the workflow completes, you MUST output:\n\n```markdown\n# Validation Summary\n\n## Tests\n\n- Status: Written and passing\n- Commit SHA: <commit_sha>\n- Summary: <test summary from Developer>\n\n## Validation\n\n- Lint: Passed\n- Format: Passed\n- Fixes Needed: <Yes/No>\n- Commit SHA: <commit_sha or \"N/A\">\n- Summary: <validation summary from Developer>\n\n## Status\n\nAll validation steps completed successfully. Implementation is ready for PR finalization.\n```\n\n---\n\n## Coordinator Behavior Rules\n\n\u2022 **CRITICAL**: Check for unpushed commits at the start and push them.\n\u2022 Call Developer agent to write comprehensive tests with complete implementation context.\n\u2022 Delegate commit and push to Developer agent after tests are written.\n\u2022 Call Developer agent to run lint and format validation.\n\u2022 Delegate commit and push to Developer agent after validation fixes (if any).\n\u2022 Collect summaries from each step for final output.\n\u2022 Provide detailed validation summary for the next step.\n\u2022 Do NOT update the PR description - that's the next step's responsibility.\n\u2022 Do NOT convert PR to ready - that's the next step's responsibility.",
          "stepMaxDurationMinutes": 60
        },
        {
          "id": "finalize-pr",
          "name": "Finalize PR",
          "action": "agent.run",
          "params": {
            "agentId": "cme8k3nx300011f331m3bobl4"
          },
          "instruction": "You are the Agent responsible for finalizing the PR: updating the PR description with complete details, converting the draft PR to ready for review, and updating the issue.\n\n## Mission\n\nUpdate the draft PR description with comprehensive implementation and validation details, convert it to ready for review, and update the triggering issue with completion status.\n\n## Scope Constraints\n\n\u2705 **Allowed Actions:**\n\n- Read outputs from previous steps (implement-changes, validate-implementation)\n- Use `update_pull_request` tool to update PR description, title, and draft status\n- Use `add_comment_to_ticket` tool to post completion comment on the issue\n\n\u274c **Prohibited Actions:**\n\n- DO NOT run tests, builds, or any validation commands\n- DO NOT execute `npm`, `yarn`, `pnpm`, or any package manager commands\n- DO NOT run linters, formatters, or type checkers\n- DO NOT modify any code files\n- DO NOT create new commits\n- All validation was already done in the validate-implementation step - trust those results\n\n**Prerequisites** (already completed by previous steps - do not re-verify):\n\n- Implementation step has completed with all phases committed and pushed\n- Validation step has completed with tests and lint/format checks passed\n- Draft PR exists from setup step\n\n**Note**: Trust the outputs from previous steps. Do not re-run any validation.\n\n## Previous Step Output with Validation Summary\n\n```\n{{outputs.validate-implementation.message}}\n```\n\n## Implementation Summary from Implement Changes Step\n\n```\n{{outputs.implement-changes.message}}\n```\n\n## Step 0 - Check for Blocker\n\nBefore doing anything, check if the prep-context output below contains `status: blocked`. If it does, **immediately** output the same blocker message verbatim and stop. Do not proceed with any other steps.\n\n\n## Overall Process\n\n1. Collect all information from previous steps:\n   - Implementation summary with all phases (from implement-changes step)\n   - Validation summary with test and lint results (from validate-implementation step)\n\n2. Update the draft PR description with comprehensive final details.\n\n3. Convert the draft PR to \"Ready for Review\":\n   - Mark the PR as ready (remove draft status)\n   - Update PR title to remove [DRAFT] prefix\n\n4. Update the triggering issue:\n   - Post completion comment with PR link and summary\n\n---\n\n## Step 1 - Update PR Description\n\nUse `update_pull_request` tool to update the existing draft PR description with comprehensive final details.\n\n**PR Description Template**:\n\n```markdown\n# <issue_title>\n\n## Overview\n\nThis PR implements <issue_title> based on the approved design document.\n\n**Issue**: <issue_url>\n\n## Implementation Summary\n\n<Include the implementation summary from previous step, organized by phase>\n\n### Phase 1: <phase_title>\n\n- <summary of changes>\n- Commit: <commit_sha>\n\n### Phase 2: <phase_title>\n\n- <summary of changes>\n- Commit: <commit_sha>\n\n## Testing\n\n- \u2705 Comprehensive tests written for all new functionality\n- \u2705 All tests passing\n- \u2705 Test coverage meets project standards\n\n## Validation\n\n- \u2705 Lint checks passed\n- \u2705 Format checks passed\n- \u2705 Code quality verified\n\n## Files Changed\n\n- **Total Commits**: <N>\n- **Implementation Commits**: <N>\n- **Test Commit**: 1\n- **Validation Commit**: 1\n\n## Review Notes\n\n<Any specific notes for reviewers based on the implementation>\n\n---\n\n_Implementation complete and ready for review._\n```\n\n---\n\n## Step 2 - Convert to Ready for Review\n\nUse `update_pull_request` tool to:\n\n1. **Update PR title**: Remove [DRAFT] prefix\n   - Before: `[DRAFT] Add user preferences endpoint`\n   - After: `Add user preferences endpoint`\n\n2. **Mark as ready**: Set draft status to false to convert from draft to ready for review\n   - This signals to reviewers that implementation is complete\n\n---\n\n## Step 3 - Update Issue\n\nUse `add_comment_to_ticket` tool to post a completion comment on the triggering issue:\n\n```markdown\n## \u2705 Implementation Complete\n\n**Pull Request**: <pr_url>\n\nImplementation is complete and ready for review.\n\n### Summary\n\n<Brief summary of what was implemented>\n\n### Implementation Details\n\n- **Phases Completed**: <N>\n- **Tests**: Comprehensive test coverage added\n- **Validation**: All lint and format checks passed\n- **Branch**: `<branch_name>`\n\n### Next Steps\n\n1. **Review**: Review the pull request for code quality and correctness\n2. **Test**: Test the implementation in appropriate environment\n3. **Merge**: Merge to base branch when approved\n\nThe PR includes a complete implementation with tests and validation.\n```\n\n---\n\n## Output Requirements\n\nWhen the workflow completes, output:\n\n```markdown\n# Finalization Complete\n\n## PR Details\n\n- **PR URL**: <pr_url>\n- **Status**: Ready for Review\n- **Branch**: <branch_name>\n\n## Summary\n\n- Implementation: <N> phases completed\n- Tests: Added and passing\n- Validation: Passed\n- Status: Ready for review\n\n## Commits\n\n- Implementation commits: <N>\n- Test commit: 1\n- Validation commit: 1\n- Total commits: <N>\n```\n\n---\n\n## Coordinator Behavior Rules\n\n**DO NOT:**\n\n- Run any test, build, lint, or format commands\n- Execute any code or scripts\n- Modify any source files\n- Create any commits\n- Use shell commands or gh CLI\n\n**DO:**\n\n- Collect implementation summary from implement-changes step output\n- Collect validation summary from validate-implementation step output\n- Use `update_pull_request` to update PR description and convert to ready-for-review\n- Use `add_comment_to_ticket` to post completion comment on issue\n- Provide detailed output with all commit information\n\n---\n\n## Success Criteria\n\nThis step is successful when:\n\n- \u2705 Draft PR is converted to ready for review\n- \u2705 PR title updated (no [DRAFT] prefix)\n- \u2705 PR description is comprehensive with implementation and validation details\n- \u2705 Triggering issue updated with completion comment\n- \u2705 PR is ready for code review",
          "stepMaxDurationMinutes": 30
        }
      ],
      "triggers": [
        {
          "event": "manual",
          "slashCommand": {
            "command": "pr",
            "requireMention": false
          }
        }
      ],
      "version": "1.0.0",
      "priority": 5,
      "timeoutMs": 14400000,
      "defaultModelKey": null,
      "statusUpdateMethod": null
    }
  },
  "refs": {
    "agents": [
      {
        "id": "cme8k3nx300011f331m3bobl4",
        "name": "Backend developer"
      },
      {
        "id": "cme8kpihf0003t3uzn7ecwiin",
        "name": "Frontend Developer"
      }
    ]
  }
}

{
  "_formatVersion": "1.0.0",
  "workflow": {
    "name": "Code Review",
    "description": "Elevate your code quality with AI-powered reviews. Overcut provides thorough, context-aware feedback on your PRs, catching bugs, security issues, and style violations before they merge.",
    "instructions": [
      {
        "description": "Overcut will automatically review your PRs every time you `open a new PR` or when you add a comment with the command `/review` on any PR. Overcut will analyze your code changes, check for bugs, suggest improvements, and provide detailed feedback with inline comments.",
        "action": "create_pr"
      }
    ],
    "definition": {
      "flow": [
        {
          "to": "git-clone",
          "from": "",
          "condition": null
        },
        {
          "to": "prepare-review-plan",
          "from": "git-clone",
          "condition": null
        },
        {
          "to": "code-review",
          "from": "prepare-review-plan",
          "condition": null
        },
        {
          "to": "optimize-review-item",
          "from": "code-review",
          "condition": null
        },
        {
          "to": "submit-review",
          "from": "optimize-review-item",
          "condition": null
        }
      ],
      "name": "Code Review",
      "steps": [
        {
          "id": "git-clone",
          "name": "Clone Repo",
          "action": "git.clone",
          "params": {
            "branch": "{{trigger.pullRequest.headBranch}}",
            "cloneOptions": {
              "depth": 1,
              "filter": {
                "type": "blob:none"
              },
              "singleBranch": true
            },
            "repoFullName": "{{trigger.repository.fullName}}"
          },
          "instruction": null,
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "prepare-review-plan",
          "name": "Prepare Review Plan",
          "action": "agent.run",
          "params": {
            "agentId": "cmck2zx350003wtwyxm0w6g6p"
          },
          "instruction": "Role: Code Review Planner  \nGoal: Create a concise, intent-based review plan for the pull request.\n\n1. Use get_pull_request_diff to inspect all file diffs.  \n2. Identify the main *logical changes* or *intents* (e.g., new feature, refactor, schema update, test, doc, config).  \n3. Group related file changes under one intent.  \n4. For each intent, summarize:\n   • What was changed (1 short phrase)\n   • Why it matters for review (key concern)\n   • Optional: key files or modules (briefly)\n\nOutput format (one line per intent):\n1. [intent / feature] — [summary of what changed and what to review briefly]\n\nKeep the plan short and non-repetitive (max 5–8 items).  \nDo not restate every file or create detailed sub-bullets.  \nDo not review the code yet — just provide a compact list of review focuses.",
          "stepMaxDurationMinutes": 30
        },
        {
          "id": "code-review",
          "name": "Code Review",
          "action": "agent.session",
          "params": {
            "goal": "Code Review",
            "agentIds": ["cmfjcucnw001aldn5dqb89cv7"],
            "agentEngine": "overcut",
            "exitCriteria": {
              "timeLimit": {
                "maxDurationMinutes": 10
              },
              "userSignals": {
                "explicit": ["/done", "thanks"]
              }
            },
            "listenToComments": false,
            "keepSessionOpenForComments": false
          },
          "instruction": "You are the **Coordinator Agent** in an ongoing code review process.  \nYou are starting with a predefined list of review items, and your job is to:\n- For each review item: delegate to the **Code Reviewer** to ANALYZE and APPEND JSONL findings directly into `.overcut/review/scratchpad.jsonl`.  \n- The Reviewer should return only a short status summary to chat.\n\n---\n\n## Process\n\n### Step 0 - Acknowledge\nUpdate the user with the `update_status` tool with a message that you are starting the code review.\n\n---\n\n### Step 1 - Per-item Analysis to Scratchpad\nFor each item in the list of review items, delegate to **Code Reviewer** this entire message in full — you must pass the schema.\n\nYou are acting as a **Code Reviewer**.  \nAnalyze the following [task].  \nDo **NOT** post any PR comments and do **NOT** call `submit_review`.  \nProduce findings matching the JSONL schema (below).  \nAppend each finding as a JSON line to `.overcut/review/scratchpad.jsonl` (at the workspace root folder, not inside the repo folder).  \nReturn ONLY a short status line to chat: `{file} - {count} findings`.  \n\n> **Guidance**:\n> - Focus on correctness, security, performance, tests, APIs, and standards.  \n> - Keep summaries terse and user-facing.  \n> - Use local anchors (snippet + up to 3 lines of context + hunk header + approx lines).  \n> - Use `'blocker'` **only** for truly critical issues that would cause incorrect behavior or security risk.  \n> - **Ignore lint-only or trivial formatting changes** (e.g., whitespace, commas, semicolons, import order, quote styles).  \n> - Avoid adding low-confidence, speculative, or nitpick findings. Only include issues that are clearly justified and relevant to the PR changes.  \n\n**Schema for each finding**:\n```json\n{\n  \"file\": \"path/to/file\",\n  \"importance\": \"blocker|major|minor|nit\",\n  \"title\": \"Short handle\",\n  \"message\": \"1-2 sentence user-facing comment\",\n  \"suggested_fix\": \"Optional concrete guidance or patch\",\n  \"line\": \"\",\n  \"side\": \"RIGHT|LEFT|UNKNOWN\"\n}\n```\n\n---\n\n### Step 2 - Complete and return a summary\nUse the `task_completed` tool to complete the task and return a summary of the review.\n\n**Output Requirements**:\n\nWhen the workflow completes, you MUST output the following information:\n\n```\nreview_comments_found: <yes|no>\ntotal_findings: <number of findings>\nscratchpad_file: .overcut/review/scratchpad.jsonl\n```\n\nExample outputs:\n\n**If findings were created:**\n```\nreview_comments_found: yes\ntotal_findings: 12\nscratchpad_file: .overcut/review/scratchpad.jsonl\n```\n\n**If no findings were created:**\n```\nreview_comments_found: no\ntotal_findings: 0\nscratchpad_file: .overcut/review/scratchpad.jsonl\n```\n",
          "stepMaxDurationMinutes": 120
        },
        {
          "id": "optimize-review-item",
          "name": "Optimize Review Items",
          "action": "agent.run",
          "params": {
            "agentId": "cmfjcucnw001aldn5dqb89cv7",
            "agentEngine": "overcut"
          },
          "instruction": "You are acting as a **Code Review Optimizer**.  \nYou are given a list of review items on a PR.  \nYour goal is to produce a **minimal, high-quality** set of review items that focuses on meaningful issues — filtering out trivial, low-confidence, or irrelevant findings — so that the final review adds clear value without overwhelming developers.\n\n---\n\n## Step 0 – Acknowledge\nUse the `update_status` tool to notify the user that optimization has started.\n\n---\n\n## Step 1 – Check for Review Comments from Previous Step\n\n**Prerequisites**:\n- The previous step should have created `.overcut/review/scratchpad.jsonl` with review findings.\n- The previous step provides output indicating whether review comments were found.\n\n**Previous step output:**\n```\n{{outputs.code-review.message}}\n```\n\n**Action**:\n1. Check the `review_comments_found` value from the previous step's output.\n2. If `review_comments_found` is **\"no\"** or `total_findings` is **0**:\n   - Use the `task_completed` tool with message: `\"No review comments found from previous step. Skipping optimization.\"`\n   - Output the following:\n     ```\n     chunks_created: no\n     total_chunks: 0\n     ```\n   - **STOP here** - do not proceed to Step 2, Step 3, or Step 4.\n3. If `review_comments_found` is **\"yes\"** and `total_findings` > 0, proceed to Step 2.\n\n---\n\n## Step 2 – Dedupe and Prune\nRead `.overcut/review/scratchpad.jsonl` (from the workspace root, not inside the repo folder).  \nApply the following optimization and filtering rules:\n\n### Deduplication\n- Merge duplicates if:\n  - Same file **and** high summary similarity, **or**\n  - Same snippet hash.\n- When merging:\n  - Keep the highest **importance** and most **specific** description.\n\n### Pruning\nDrop or merge items based on these criteria:\n- **Ignore lint-only changes**:\n  - Skip findings that relate only to formatting, whitespace, import order, semicolons, trailing commas, quote style, or other stylistic diffs.\n  - If a finding points to a line that changed only in formatting (no logic), discard it.\n- **Drop no-op or trivial items** (e.g., “variable could be renamed,” “add blank line,” etc.).\n- **Drop low-confidence items** that lack clear reasoning or are speculative (“might,” “maybe,” “possibly”).\n- **Drop out-of-scope findings** that do not relate to the current PR changes, unless they are **critical** (security, correctness, or stability).\n- **Drop nitpicks** — small subjective preferences that don’t affect correctness, maintainability, or readability.\n- **Collapse repetitive housekeeping**:\n  - If multiple similar style issues appear in the same file (imports, spacing, etc.), collapse them into one summary note per file.\n\n### Noise Reduction\n- Prefer **fewer, higher-confidence** comments that reflect clear problems or improvements.\n- Each retained finding must represent a **distinct and meaningful insight**.\n- The goal is to make Overcut’s review **concise and high-signal**.\n\n---\n\n## Step 3 – Split into Chunks\nAfter pruning, split the optimized findings into chunks for downstream agents.\n\n### Chunking Rules\n- Default partitioning is by file — all findings for one file go in one chunk.\n- If a file has more than ~10 findings, split it into multiple smaller chunks.\n- If a chunk has fewer than 5 findings, merge it with an adjacent chunk so every chunk has at least 5 findings (unless the file has fewer overall).\n- Ensure every finding appears in **exactly one** chunk.\n\n**Outputs**:  \n- Write each chunk as a JSONL file named `.overcut/review/scratchpad.chunk{N}.jsonl`. (at the workspace root folder, not inside the repo folder)\n\n---\n\n## Step 4 - Return a summary\nUse the `task_completed` tool to complete the task and return a summary of the review.\nReturn to chat a short status: `\"kept={k} merged={m} dropped={d} chunks={c}\"`.\n\n**Output Requirements**:\n\nWhen the workflow completes, you MUST output the following information:\n\n```\nchunks_created: <yes|no>\ntotal_chunks: <number of chunk files created>\nkept_findings: <number of findings kept after optimization>\n```\n\nExample outputs:\n\n**If chunks were created:**\n```\nchunks_created: yes\ntotal_chunks: 3\nkept_findings: 8\n```\n\n**If no findings remained after optimization:**\n```\nchunks_created: no\ntotal_chunks: 0\nkept_findings: 0\n```\n",
          "stepMaxDurationMinutes": 120
        },
        {
          "id": "submit-review",
          "name": "Submit Review Results",
          "action": "agent.session",
          "params": {
            "goal": "Write and Submit Review Comments",
            "agentIds": [
              "cmfjcucnw001aldn5dqb89cv7",
              "cmck2zx350003wtwyxm0w6g6p",
              "cmex5b4zf0001wvjvgnv9aced"
            ],
            "agentEngine": "overcut",
            "exitCriteria": {
              "timeLimit": {
                "maxDurationMinutes": 120
              },
              "userSignals": {
                "explicit": ["/done", "thanks"]
              }
            },
            "listenToComments": true,
            "keepSessionOpenForComments": false
          },
          "instruction": "You are acting as a **Code Review Publisher**.  \nYour goal is to process all chunk files in the `.overcut/review/` folder (at the workspace root folder, not inside the repo folder), post PR comments, and submit the final review.\n\n## Process\n\n### Step 0 - Acknowledge\n\nUpdate the user with the update_status tool with a message that you are starting the process.\n\n---\n\n### Step 1 - Check for Review Comments from Previous Step\n\n**Prerequisites**:\n\n- The previous step (step-3-optimize-review-item) should have created `.overcut/review/scratchpad.chunk*.jsonl` files.\n- The previous step provides output indicating whether chunks were created.\n\n**Previous step output:**\n\n```\n{{outputs.optimize-review-item.message}}\n```\n\n**Action**:\n\n1. Check the `chunks_created` value from the previous step's output.\n2. If `chunks_created` is **\"no\"** or `total_chunks` is **0** or `kept_findings` is **0**:\n   - Use the `task_completed` tool with message: `\"Code review complete. No issues found - all changes look good! ✅\"`\n   - **STOP here** - do not proceed to Step 2, Step 3, or Step 4.\n3. If `chunks_created` is **\"yes\"** and `total_chunks` > 0, proceed to Step 2.\n\n---\n\n## Step 2 – Process Each Chunk with the Sub-Agent\n\nFor each chunk file:\n\n- Delegate it to the **Code Reviewer** agent individually.\n- **Use the exact template below** when delegating to ensure full context is passed:\n\n---\n\n**DELEGATION TEMPLATE FOR STEP 2 (Post Comments):**\n\n```\nYou are a **Code Review Publisher**.\n\n## Your Mission\n\nYour task is to post review comments from a pre-processed chunk file to the pull request. All findings have already been analyzed and filtered - you are ONLY posting them, not conducting a new review.\n\n## Context\n\n- Chunk file to process: `{chunkFile}`\n- This is part of a multi-chunk review process\n- The coordinator will submit the final review after all chunks are processed\n- Your role is LIMITED to posting comments as individual threads\n\n## Instructions\n\n1. **Load findings** from file `{chunkFile}` (at the workspace root folder, not inside the repo folder)\n\n2. **For each finding in the chunk file**:\n   - Resolve line numbers using `get_pull_request_diff_line_numbers` tool\n   - If line numbers are ambiguous: fallback to file-level comment\n   - Post the comment using `add_pull_request_review_thread` tool\n   - Include the importance level at the beginning: `[IMPORTANCE]: {comment}`\n\n3. **Return to chat** only: `\"posted {count} comments from {chunkFile}\"`\n\n## CRITICAL RESTRICTIONS\n\n❌ **DO NOT** call `submit_review` tool - the review will be submitted later by the coordinator\n❌ **DO NOT** review the PR or look for new issues - only post the existing comments from the chunk file\n❌ **DO NOT** submit or finalize anything - just add the comments as individual threads\n❌ **DO NOT** add any comments that are not in the chunk file\n❌ **DO NOT** modify or editorialize the comments - post them as written\n\n✅ **DO** use `add_pull_request_review_thread` tool to post each comment\n✅ **DO** process every finding in the chunk file\n✅ **DO** return a simple status message when done\n\n## Why These Restrictions?\n\nThe review process is split into phases:\n1. (Previous steps) Analysis and filtering → created chunk files\n2. (Your task) Post comments → add review threads WITHOUT submitting\n3. (Next step) Finalization → coordinator submits the final review with summary\n\nSubmitting the review prematurely would prevent other chunks from being processed and would result in an incomplete review.\n\n## Expected Output\n\nReturn only: `\"posted {count} comments from {chunkFile}\"`\n\nDo NOT include summaries, statistics, or additional commentary.\n```\n\n---\n\n## Step 3 – Finalize and Submit the Review with a Sub-Agent\n\nAfter all chunks are processed and all comments have been added in Step 2:\n\n- Delegate this step to the **Code Reviewer** agent.\n- **Use the exact template below** when delegating to ensure full context is passed:\n\n---\n\n**DELEGATION TEMPLATE FOR STEP 3 (Submit Final Review):**\n\n```\nYou are a **Code Review Finalizer**.\n\n## Your Mission\n\nYour task is to submit the final review with a comprehensive summary. All individual comments have already been posted to the PR by other agents in previous steps. You will NOT post new comments - only submit the final review with a summary.\n\n## Context\n\n- All chunk files have been processed: `.overcut/review/scratchpad.chunk*.jsonl`\n- Individual review comments have already been posted to the PR\n- The PR is waiting for final review submission with summary\n- Location: workspace root folder, not inside the repo folder\n\n## Instructions\n\n### 1. Read All Chunk Files for Statistics\n\nRead all files matching `.overcut/review/scratchpad.chunk*.jsonl` to gather:\n\n- **Count total comments** by importance level:\n  - BLOCKER\n  - CRITICAL\n  - MAJOR\n  - MINOR\n  - SUGGESTION\n  - PRAISE\n- **Identify affected files**\n- **Note any blocking issues**\n\n### 2. Build Final Summary\n\nCreate a concise summary that includes:\n\n- **Total counts by importance level** (e.g., \"2 CRITICAL, 5 MAJOR, 3 MINOR\")\n- **1–3 key themes or patterns** observed across the review (e.g., \"Error handling gaps\", \"Missing validation\")\n- **Clear, actionable next steps** for the developer (be concise and helpful)\n\n### 3. Choose Review Event\n\nSelect the appropriate review event based on findings:\n\n- **`APPROVE`** – No blockers or critical issues found\n- **`COMMENT`** – Issues or suggestions present, but none are blocking\n- **`REQUEST_CHANGES`** – Only if truly critical correctness or security issues are found\n\n**Important**: Do not block the PR for stylistic or minor issues. Blocking should occur **only for critical issues** that would cause incorrect behavior or security risk.\n\n### 4. Submit Review\n\nCall `submit_review` tool **exactly once** with:\n\n- The summary you built in step 2\n- The event you chose in step 3\n\n### 5. Handle Errors\n\nIf you cannot call the `submit_review` tool:\n\n- Do NOT try to review or add new comments\n- Return a short status: `\"Cannot submit review. <reason>.\"`\n\n### 6. Return Status\n\nReturn to chat only: `\"Review submitted: {event}. Total comments: {N} across {M} files.\"`\n\n## CRITICAL RESTRICTIONS\n\n❌ **DO NOT** call `add_pull_request_review_thread` - comments are already posted\n❌ **DO NOT** re-post or re-add any comments from the chunk files\n❌ **DO NOT** review the PR or look for new issues - only summarize existing findings\n❌ **DO NOT** call `submit_review` more than once - submit only at the very end\n❌ **DO NOT** skip the `submit_review` tool - without it, the user will not see the final review\n\n✅ **DO** call `submit_review` tool exactly once with the final summary and event\n✅ **DO** read chunk files only to build summary statistics\n✅ **DO** choose the review event thoughtfully based on severity\n✅ **DO** keep the summary concise and actionable\n\n## Why These Restrictions?\n\nThe review process is split into phases:\n1. (Previous steps) Analysis and filtering → created chunk files\n2. (Previous step) Post comments → added all review threads to PR\n3. (Your task) Finalization → submit review with summary and approve/comment/request changes\n\nYou are submitting the FINAL review. All comments are already on the PR. Your job is to:\n- Summarize what was found\n- Choose the appropriate review event (approve/comment/request changes)\n- Submit once and only once\n\nAdding new comments or re-posting existing ones would create duplicates and confuse the review.\n\n## Expected Output\n\nReturn only: `\"Review submitted: {event}. Total comments: {N} across {M} files.\"`\n```\n\n---\n\n## Step 4 - Confirm to user\n\nUse the task_completed tool to complete the task and return a summary of the review.\nReturn to chat a short status: `\"Review submitted: {event}. Total comments: {N} across {M} files.\"`.",
          "stepMaxDurationMinutes": 120
        }
      ],
      "triggers": [
        {
          "event": "pull_request_opened",
          "schedule": null,
          "settings": {
            "delaySeconds": 0
          },
          "conditions": {
            "field": null,
            "rules": [
              {
                "field": "context.pullRequest.draft",
                "rules": null,
                "value": "false",
                "operator": "equals",
                "combinator": null
              }
            ],
            "value": null,
            "operator": null,
            "combinator": "and"
          }
        },
        {
          "event": "manual",
          "slashCommand": {
            "command": "review",
            "requireMention": false
          }
        }
      ],
      "version": "1.0.0",
      "priority": 3,
      "timeoutMs": 3600000
    }
  },
  "refs": {
    "agents": [
      {
        "id": "cmck2zx350003wtwyxm0w6g6p",
        "name": "Senior Developer"
      },
      {
        "id": "cmex5b4zf0001wvjvgnv9aced",
        "name": "Technical Writer"
      },
      {
        "id": "cmfjcucnw001aldn5dqb89cv7",
        "name": "Code Reviewer"
      }
    ]
  }
}
